# Проект: Інтеграція Autonomous LLM Provider MCP ("Клим")

**Мета**: Створення автономного агента "Клим" на базі `llm-provider-mcp`, який асинхронно виконує ресурсомісткі задачі, підключаючись як клієнт до `grynya-mcp-server` по SSE.
**Терміни**: 1-2 тижні (залежно від складності вирішення конфліктів Event Loop).
**Команда**: Гриня (AI Agent).
**Обмеження**: Збереження стану in-memory, асинхронність без використання зовнішніх черг (RabbitMQ/Celery), стабільність головного сервера при повисанні задач.

---

## Майлстоуни

| # | Майлстоун | Цільова Дата | Відповідальний | Критерії Успіху |
|---|-----------|--------------|----------------|-----------------|
| 1 | Асинхронний Task Manager | Кінець Фази 1 | Гриня | Інструмент `start_async_agent_task` запускає фонові задачі і миттєво повертає `task_id` без блокування. |
| 2 | Система моніторингу | Кінець Фази 1 | Гриня | Інструмент `check_task_status` коректно повертає стан задачі та захоплені логи (stdout/stderr). |
| 3 | Базовий PoC Клієнта | Кінець Фази 2 | Гриня | Клим успішно підключається до `grynya-mcp-server` по SSE зсередини задачі і рапортує про готовність. |
| 4 | Надійність та стабільність | Кінець Фази 3 | Гриня | Реалізовані тайм-аути та підтримка примусового скасування (cancel) задач. |

---

## Фаза 1: Асинхронна Інфраструктура (Тиждень 1)

| Задача | Трудовитрати | Відповідальний | Залежить Від | Критерії Виконання |
|--------|-------------|----------------|--------------|-------------------|
| Створення `TaskManager` | 4г | Гриня | - | Реалізовано збереження `task_id` -> `TaskState` (status, logs, result) in-memory пулі. |
| Розробка `start_async_agent_task` | 4г | Гриня | TaskManager | MCP інструмент приймає параметри задачі, робить `asyncio.create_task` і повертає id. |
| Розробка `check_task_status` | 2г | Гриня | TaskManager | MCP інструмент дозволяє зчитати поточний статус та буфер логів по конкретному `task_id`. |
| Перехоплення логів (stdout/stderr) | 4г | Гриня | TaskManager | Під час виконання таски, весь її консольний вивід записується у властивість `logs` у `TaskState`. |

---

## Фаза 2: Інтеграція MCP Клієнта (PoC) (Тиждень 2)

| Задача | Трудовитрати | Відповідальний | Залежить Від | Критерії Виконання |
|--------|-------------|----------------|--------------|-------------------|
| Перенос `test_client.py` логіки у воркер | 6г | Гриня | Фаза 1 | Код клієнтського SSE-підключення (з попереднього PoC) інтегрований як логіка воркера для задач. |
| Вирішення Event Loop Conflict | 8г | Гриня | Клієнт | Безпечне відкриття `mcp.client.sse.mcp_client` зсередини іншої MCP-сесії FastMCP без крашів `asyncio`. |
| Реалізація PoC Задачі "Звіт" | 4г | Гриня | Event Loop | Автономний агент рапортує кінцевий результат генерації "Бачу базу та інструменти, полет нормальний". |

---

## Фаза 3: Вдосконалення (Should Have) (Тиждень 2)

| Задача | Трудовитрати | Відповідальний | Залежить Від | Критерії Виконання |
|--------|-------------|----------------|--------------|-------------------|
| Механізм скасування (Cancel) | 4г | Гриня | Фаза 1 | Інструмент для виклику `.cancel()` на `asyncio.Task`. |
| Прямий запис у Граф | 4г | Гриня | Фаза 2 | Клим самостійно викликає інструмент бази даних на `grynya-mcp-server` для збереження проміжного результату. |

---

## Карта Залежностей

```
[TaskManager] ──> [start_async_agent_task] ──> [Перехоплення логів] ──> [Cancel Task]
      ├──> [check_task_status]                       |
      └──────────────────────────────────────────────> [Внутрішній MCP Клієнт] ──> [Event Loop Conflict] ──> [PoC Звіт] ──> [Прямий запис у Граф]
```

## Ризики та Мітигація

| Ризик | Вплив | Імовірність | Мітигація |
|-------|-------|-------------|-----------|
| Конфлікт Event Loop при `asyncio.create_task` | Високий | Висока | Розглянути запуск воркера у `ThreadPoolExecutor` або `ProcessPoolExecutor`, якщо нативний `asyncio` не впорається з вкладенням MCP. |
| Втрата логів при краші | Середній | Середня | PoC допускає in-memory. Для production в майбутньому можливо знадобиться SQLite або файл. |
