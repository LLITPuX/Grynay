# Протокол `/ss` (Закриття сесії та Бекап)

Цей протокол виконується для завершення активної сесії, підбиття підсумків та створення бекапу на файловій системі.

**Тригер:** Команда `/ss "коментар"` від користувача.
**Семантика:** `/ss` закриває активну сесію. Якщо є текст у лапках, він вважається фінальним фідбеком.

> [!CAUTION]
> ПРОТОКОЛ СКЛАДАЄТЬСЯ З ТРЬОХ ОБОВ'ЯЗКОВИХ КРОКІВ. ТИ МАЄШ ВИКОНАТИ ЇХ УСІ ПО ЧЕРЗІ.

## Крок 1: Запис у FalkorDB (Взаємодія з MCP)

Використовуй нативні інструменти (tools) MCP-сервера для закриття сесії:

1.  **Зміна статусу:** Виклич інструмент `mcp_falkordb_add_node` для поточної Session (передай той самий `id` і оновлений атрибут `status: 'closed'`).
2.  **Фідбек (опціонально):** Якщо користувач передав текст, створи `:Feedback` за допомогою `mcp_falkordb_add_node` з відповідними зв'язками.
3.  **Відповідь:** Створи фінальний `:Response` з повним текстом своєї відповіді (СЛОВО В СЛОВО).
4.  **Аналіз (Session Summary):** Створи `:Analysis` з типом `session_summary` використовуючи `mcp_falkordb_add_node`. Підсумуй усю сесію: `verdict`, `topics`, `tasks_completed`, `key_decisions`, `errors`, `lessons`. 
    *Зв'язки:* `SUMMARIZES` -> Session та `ANALYZES` -> Response.
    > **УВАГА:** ЗАБОРОНЕНО передавати зв'язки `NEXT` через параметр `relations` інструменту `add_node`. Для `NEXT` переходь до пункту 4.1.
4.1. **Створення хронологічного ланцюгу `NEXT`:** ОБОВ'ЯЗКОВО виклич інструмент `mcp_falkordb_batch_link_nodes` та передай масив зв'язків `NEXT` (Від попередньої події -> Feedback -> Response -> Analysis).
5.  **Сутності (`:Entity`):** Якщо є нові сутності у фінальній репліці, використай `mcp_falkordb_batch_add_nodes`. Далі використай `mcp_falkordb_batch_link_nodes` для прив'язки Analysis до УСІХ сутностей, що існували в цій сесії (через `[:MENTIONS]`).
6.  **LAST_EVENT:** Виклич `mcp_falkordb_update_last_event` для оновлення вказівника на фінальний Analysis.

## Крок 2: Збереження повного логу (Бекап) у файл

Ти маєш створити файл у директорії `c:\Antigarvity_workspace\saved_sessions\` (використовуючи інструмент `write_to_file`).

1. **Збір історії:** Збери ВСІ повідомлення поточної сесії (запити, дії, повні відповіді слово в слово).
2. **Визначення теми:** Сформуй коротку тему англійською (snake_case, макс 50 символів), наприклад `graph_schema_refactoring`.
3. **Генерація імені файлу:** Формат `session_YYYY-MM-DD_HH-MM-SS_тема.md`. (Наприклад: `session_2026-02-22_19-50-00_graph_schema_refactoring.md`).
4. **Створення файлу:** Використовуй наступний шаблон:

````markdown
# Сесія: <автоматично визначена тема>

**Дата:** <дата>, <час>
**Тема:** <повна тема>

---

## Запит користувача #1
```
<текст запиту>
```
### Аналіз та дії
<аналіз та дії агента>
### Відповідь #1
<повна відповідь агента, СЛОВО В СЛОВО>

---
*(додати всі наступні запити та відповіді)*
---

## Підсумок сесії

### Обговорені теми:
1. <тема 1>

### Виконані завдання:
1. ✅ <завдання 1>

### Результат:
<коротке резюме>

---
**Кінець сесії**
````

5.  **Оновлення Сесії в Базі:** Після створення файлу, зафіксуй його шлях у графі, викликавши інструмент `mcp_falkordb_add_node` (передавши `id` поточної сесії та новий атрибут `file_path: '<повний шлях до файлу>'`).

## Крок 3: Git Commit та Push (зміни проєкту)

Закоміть та запуш усі зміни у проєкті (скіли, правила, код). Логи сесій не попадуть у коміт — вони в `.gitignore`.

```powershell
git add -A
git commit -m "session: <коротка тема сесії>"
git push
```

**Виконання:** Подякуй користувачу за сесію.

## Підтвердження
Поверни користувачу:
```text
✅ Сесія закрита та збережена:
   - FalkorDB: Session [id] → status: closed
   - Файл: saved_sessions/session_<...>.md
   - Git: committed & pushed
```
