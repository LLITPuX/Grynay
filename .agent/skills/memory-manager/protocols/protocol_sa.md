# Протокол `/sa` (Продовження сесії)

Цей протокол використовується для продовження відкритої теми.

**Тригер:** Команда `/sa "коментар"` від користувача.
**Семантика:** `/sa` продовжує активну сесію, зберігаючи логічний зв'язок з контекстом.

> [!CAUTION]
> **КРИТИЧНЕ ПРАВИЛО: `/sa` = Feedback + Response + Analysis.**
> Протокол `/sa` ЗАВЖДИ створює три вузли одночасно: `:Feedback`, `:Response` та `:Analysis`.
> Агент НІКОЛИ не може зберегти фідбек без своєї відповіді та аналізу.
> Analysis — це НЕ опція. Без нього хронологічний ланцюг розривається.

## Твої дії (Формування JSON для `memory_bridge.py`)

Ти маєш згенерувати JSON та додати його до існуючої гілки діалогу.

### Крок 1: Вкажи Сесію

Додай блок `session` лише з поточним `id` (статус НЕ змінюється).

### Крок 2: Створи вузол `:Feedback`

Збережи текст коментаря користувача.

### Крок 3: Створи вузол `:Response`

> [!IMPORTANT]
> **ОБОВ'ЯЗКОВО!** Збережи ПОВНИЙ текст своєї відповіді СЛОВО В СЛОВО.

Атрибути: `id`, `name`, `author: 'Grynya'`, `summary`, `full_text` (ПОВНИЙ текст), `type: 'text'`.

### Крок 4: Створи вузол `:Analysis`

> [!IMPORTANT]
> **ОБОВ'ЯЗКОВО!** Analysis створюється для КОЖНОГО Response без винятків.

Тип: `response_analysis`. Включає `verdict`, `rules_used`, `errors`, `lessons`.

*   Самоаналіз: Чи правильно я зрозумів фідбек? Які правила використав? Де помилився?
*   Якщо помилок немає — `errors: []`, але Analysis все одно створюється.

### Крок 5: Витягни сутності (`:Entity`)

ОБОВ'ЯЗКОВО! Проаналізуй поточний обмін репліками та витягни або онови **УСІ** релевантні сутності (не лише нові, а й ті що вже згадувалися), щоб зв'язати їх з новими вузлами.

### Крок 6: Налаштуй Зв'язки (`relations`)

*   Всі нові вузли `PART_OF` поточна Session.
*   Feedback `FEEDBACK_ON` попередній Response (або Analysis).
*   Response `RESPONDS_TO` Feedback.
*   Analysis `ANALYZES` Response.
*   Feedback, Response, Analysis `MENTIONS` Entity.

### Крок 7: Налаштуй Хронологію (`chronology`)

*   Вкажи точний час (`time`).
*   Створи `next_links`:
    *   Від попереднього останнього вузла (`last_event_id` сесії) до Feedback.
    *   Від Feedback до Response.
    *   Від Response до Analysis.
*   Онови `last_event_id` на ID **Analysis** (НЕ Response!).

> [!CAUTION]
> **`last_event_id` ЗАВЖДИ вказує на Analysis, бо це останній вузол у трійці.**
> Якщо вказати на Response — наступний Feedback не зв'яжеться з Analysis, і ланцюг порушиться.

**Виконання:** Передай JSON скрипту `memory_bridge.py` через `run_command` та поверни користувачу підтвердження "✅ Артефакт збережено [ID вузлів]".

> [!IMPORTANT]
> **Очищення:** Якщо використовувався тимчасовий файл, видали його одразу після завершення `run_command`.
